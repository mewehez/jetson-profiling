#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include <signal.h>
#include <time.h>
#include "profiling/argparse.h"

#define POWER_USAGE_STRING  "Usage of power profiler: ./power [--output=OUTPUT] [--log] [--help]\n"\
                            "--output=OUTPUT        The path of the file in which to write the power consumption.\n"\
                            "--log                  Display values in the consol.\n"\
                            "--help                 Show the help message.\n\n"

#define COLOR_BLUE      "\033[0;34m"
#define COLOR_GREEN     "\033[0;32m"
#define COLOR_WHITE     "\033[1;37m"
#define COLOR_NONE      "\033[0m"

typedef struct timespec timespec;

void timestamp( timespec* timestampOut )
{ 
    if(!timestampOut) 
        return; 
    timestampOut->tv_sec=0; 
    timestampOut->tv_nsec=0; 
    clock_gettime(CLOCK_REALTIME, timestampOut); 
}

void time_diff( const timespec* start, const timespec* end, timespec* result )
{
	if ((end->tv_nsec-start->tv_nsec)<0) {
		result->tv_sec = end->tv_sec-start->tv_sec-1;
		result->tv_nsec = 1000000000+end->tv_nsec-start->tv_nsec;
	} else {
		result->tv_sec = end->tv_sec-start->tv_sec;
		result->tv_nsec = end->tv_nsec-start->tv_nsec;
	}
}

double time_double( const timespec* a )	
{ 
    return a->tv_sec * 1000.0 + a->tv_nsec * 0.000001; 
}



char* read_rail(char* file_path);

void usage(void)
{
    printf(POWER_USAGE_STRING);
}

bool log_values = false;
char* output_file = NULL;
char buffer[100] = "";
FILE* output_fp = NULL;
int shutdown_flag = 0;

void sigint_handler(int sig)
{
    printf("\nCaught SIGINT!\n");
    shutdown_flag = 1;
    // fclose(output_fp);
}

void read_data(FILE* fp, int* value)
{
    fseek(fp, 0, SEEK_SET);
    fscanf(fp, "%d", value);
    // fgets(value, 6, fp);
    // value[6] = '\0';
    // fseek(fp, 0, SEEK_SET);
}

int main(int argc, char** argv)
{
    arg_option options[] = {
        OPT_BOOLEAN('l', "log", NULL),
        OPT_BOOLEAN('h', "help", NULL),
        OPT_STRING('o', "output", NULL)
    };
    const int cmd_size = 3;
    
    command_line cmd = { options, cmd_size };
    parse_command_line(&cmd, argc, argv);
    
    void* value = get_option_value(&cmd, "help");
    if(value)
    {
        usage();
        exit(0);
    }

    // bind signal listener
    if (signal(SIGINT, sigint_handler) == SIG_ERR)
        printf("[Error] signal SIGINT error\n");

    value = get_option_value(&cmd, "log");
    if(value)
        log_values = true;
    
    value = get_option_value(&cmd, "output");
    if(!value)
    {
        output_file = "profiling_output.csv";
        printf(COLOR_WHITE "Output file is empty. Using default %s.\n" COLOR_NONE, output_file);
    }
    else
        output_file = (char*)value;

    // print some info
    printf(COLOR_GREEN "\nWatching sensor: " COLOR_WHITE "%s\n" COLOR_NONE, "ALL");
    printf(COLOR_GREEN "Output file: " COLOR_WHITE "%s\n" COLOR_NONE, output_file);

    // sysfs i2c INA base path
    char* base_path="/sys/bus/i2c/drivers/ina3221x/6-0040/iio:device0/";

    // define paths
    char curr0_path[100],volt0_path[100], pow0_path[100]; 
    char curr1_path[100],volt1_path[100], pow1_path[100]; 
    char curr2_path[100],volt2_path[100], pow2_path[100];

    sprintf(curr0_path, "%sin_current0_input", base_path); 
    sprintf(curr1_path, "%sin_current2_input", base_path); 
    sprintf(curr2_path, "%sin_current2_input", base_path);

    sprintf(volt0_path, "%sin_voltage0_input", base_path);  
    sprintf(volt1_path, "%sin_voltage1_input", base_path);  
    sprintf(volt2_path, "%sin_voltage2_input", base_path);

    sprintf(pow0_path, "%sin_power0_input", base_path);  
    sprintf(pow1_path, "%sin_power1_input", base_path);  
    sprintf(pow2_path, "%sin_power2_input", base_path);  

    // read rail names
    // 0- Is input
    sprintf(buffer, "%srail_name_0", base_path);
    char* rail_name_0 = read_rail(buffer);
    // 1- Is GPU
    sprintf(buffer, "%srail_name_1", base_path);
    char* rail_name_1 = read_rail(buffer);
    // 2- Is CPU
    sprintf(buffer, "%srail_name_2", base_path);
    char* rail_name_2 = read_rail(buffer);

    // print rales
    printf("\n");
    printf(COLOR_GREEN "Rail 0: " COLOR_WHITE "%s\n" COLOR_NONE, rail_name_0);
    printf(COLOR_GREEN "Rail 1: " COLOR_WHITE "%s\n" COLOR_NONE, rail_name_1);
    printf(COLOR_GREEN "Rail 2: " COLOR_WHITE "%s\n" COLOR_NONE, rail_name_2);

    // open pointer to files
    FILE* curr0_fp, *volt0_fp, *pow0_fp;
    FILE* curr1_fp, *volt1_fp, *pow1_fp;
    FILE* curr2_fp, *volt2_fp, *pow2_fp;

    curr0_fp = fopen(curr0_path, "r");
    curr1_fp = fopen(curr1_path, "r");
    curr2_fp = fopen(curr2_path, "r");

    volt0_fp = fopen(volt0_path, "r");
    volt1_fp = fopen(volt1_path, "r");
    volt2_fp = fopen(volt2_path, "r");

    pow0_fp  = fopen(pow0_path, "r");
    pow1_fp  = fopen(pow1_path, "r");
    pow2_fp  = fopen(pow2_path, "r");

    // check that all files are ok
    if(!curr0_fp || !curr1_fp || !curr2_fp || !volt0_fp || !volt1_fp || !volt2_fp || !pow0_fp || !pow1_fp || !pow2_fp)
        goto cleaning_up;

    // file pointer
    FILE *output_fp = fopen(output_file, "w");

    // write header string
    fprintf(output_fp, "start_time;");
    fprintf(output_fp, "in_current_%s;in_voltage_%s;in_power_%s", rail_name_0, rail_name_0, rail_name_0);
    fprintf(output_fp, "in_current_%s;in_voltage_%s;in_power_%s", rail_name_1, rail_name_1, rail_name_1);
    fprintf(output_fp, "in_current_%s;in_voltage_%s;in_power_%s;duration\n", rail_name_2, rail_name_2, rail_name_2);

    timespec time_s, time_e, ellapsed;
    // char read[10];
    int val;
    printf(COLOR_BLUE "\nStartted Recording ...\n" COLOR_NONE);
    while(true)
    {
        timestamp(&time_s);

        // write starting time
        fprintf(output_fp, "%f;", time_double(&time_s));

        // read and write values
        read_data(curr0_fp, &val);
        fprintf(output_fp, "%d;", val);
        read_data(volt0_fp, &val);
        fprintf(output_fp, "%d;", val);
        read_data(pow0_fp, &val);
        fprintf(output_fp, "%d;", val);

        read_data(curr1_fp, &val);
        fprintf(output_fp, "%d;", val);
        read_data(volt1_fp, &val);
        fprintf(output_fp, "%d;", val);
        read_data(pow1_fp, &val);
        fprintf(output_fp, "%d;", val);

        read_data(curr2_fp, &val);
        fprintf(output_fp, "%d;", val);
        read_data(volt2_fp, &val);
        fprintf(output_fp, "%d;", val);
        read_data(pow2_fp, &val);
        fprintf(output_fp, "%d;", val);

        /*# print values
        # echo ""
        # echo "$(printf "${BLUE}[%s]" "$(date +"%D %T")")"
        # echo "$(printf "${WHITE}%-10s | ${NO_COLOR}Current: %4u mA -- Voltage: %4u mV -- Power: %4u mW" ${RAIL_NAME_0} ${in_current_0} ${in_voltage_0} ${in_power_0})"
        # echo "$(printf "${WHITE}%-10s | ${NO_COLOR}Current: %4u mA -- Voltage: %4u mV -- Power: %4u mW" ${RAIL_NAME_1} ${in_current_1} ${in_voltage_1} ${in_power_1})"
        # echo "$(printf "${WHITE}%-10s | ${NO_COLOR}Current: %4u mA -- Voltage: %4u mV -- Power: %4u mW" ${RAIL_NAME_2} ${in_current_2} ${in_voltage_2} ${in_power_2})"

        # append values to line
        line="${line}; ${in_current_0}; ${in_voltage_0}; ${in_power_0}"
        line="${line}; ${in_current_1}; ${in_voltage_1}; ${in_power_1}"
        line="${line}; ${in_current_2}; ${in_voltage_2}; ${in_power_2}"*/

        // compute duration
        timestamp(&time_e);
        time_diff(&time_s, &time_e, &ellapsed);

        // write duration
        fprintf(output_fp, "%f\n", time_double(&ellapsed));

        if(shutdown_flag) 
            break;
    }

    printf("Cleaning up...\n");

    // close all files
    fclose(curr0_fp);
    fclose(curr1_fp);
    fclose(curr2_fp);

    fclose(volt0_fp);
    fclose(volt1_fp);
    fclose(volt2_fp);

    fclose(pow0_fp);
    fclose(pow1_fp);
    fclose(pow2_fp);

    fclose(output_fp);

    // free dynamically allocated values
    cleaning_up:
    free_command_line(&cmd);
    free(rail_name_0);
    free(rail_name_1);
    free(rail_name_2);
    return 0;
}

char* read_rail(char* file_path)
{ 
    FILE *fp = fopen(file_path, "r");
    if(fp == NULL) {
        printf("[Error] Unable to open file %s\n", file_path);
        return NULL;
    }
    char chunk[20] = "";
    fgets(chunk, sizeof(chunk), fp);
    fclose(fp);

    // dynamically allocate memory for result
    int size = strlen(chunk);
    char* value = calloc(size, sizeof(char));
    // remove the end of line character
    strncpy(value, chunk, size-1);
    value[size-1] = '\0';
    return value;
}
